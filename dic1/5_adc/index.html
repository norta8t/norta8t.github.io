<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>5. ADC - Analog Digital Converter - HEL - DIC1</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "5. ADC - Analog Digital Converter";
        var mkdocs_page_input_path = "5_adc.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> HEL - DIC1
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">0. Herzlich Willkommen zu DIC1</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../1_digital/">1. Digitale Elektronik</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../2_c/">2. C-Programmierung</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../3_timer/">3. Timer</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../4_switches/">4. Schalter / Pegelwandlung</a>
                </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="#">5. ADC - Analog Digital Converter</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#51-aufgabe-herausforderung">5.1 Aufgabe / Herausforderung</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#52-messverfahren">5.2 Messverfahren</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#53-atmega16-adc">5.3 ATmega16 ADC</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#531-kenngroen">5.3.1 Kenngrößen</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#532-blockschaltbild">5.3.2 Blockschaltbild</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#533-referenzspannung">5.3.3 Referenzspannung</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#534-prescaling">5.3.4 Prescaling</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#534-multiplexer">5.3.4 Multiplexer</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#535-adc-register">5.3.5 ADC Register</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#536-modi">5.3.6 Modi</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#537-unterschied-single-endeddifferential-input">5.3.7 Unterschied single ended/differential input</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#538-genauigkeit-und-fehler">5.3.8 Genauigkeit und Fehler</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#539-elektrische-eigenschaften-adc">5.3.9 Elektrische Eigenschaften (ADC)</a>
    </li>
        </ul>
    </li>
    </ul>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../6_dac/">6. DAC - Digital Analog Converter</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../7_uart/">7. Schnittstellen</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../A_ressources/">A. Ressourcen</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">HEL - DIC1</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">5. ADC - Analog Digital Converter</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="5-adc-analog-digital-converter">5. ADC - Analog Digital Converter</h1>
<h2 id="51-aufgabe-herausforderung">5.1 Aufgabe / Herausforderung</h2>
<p>Eine Analoge Spannung soll in einen digitalen Wert umgewandelt werden um vom Mikrocontroller weiter bearbeitet zu werden. 
Beispiel Voltmeter, Auslesen eines analogen Sensorwertes, ...</p>
<p>Die Herausforderung ist dabei, dass...</p>
<ol>
<li>der Messfehler möglichst klein sein soll</li>
<li>eine entsprechend geeignete Auflösung für die Messaufgabe verwendet wird </li>
</ol>
<h2 id="52-messverfahren">5.2 Messverfahren</h2>
<p>Es gibt verschiedene Verfahren, um analoge Signale in digitale umzuwandeln, z.B. Flash Wandler, Pipeline Wandler, Sigma-Delta Wandler, Slope Wandler und SAR-Wandler.</p>
<p>Ein Vergleich der verschiedenen Typen und deren bevorzugte Anwendung findest sich z.B. <a href="https://www.digikey.at/de/articles/match-the-right-adc-to-the-application">hier</a>.</p>
<p>Beim ATmega16 wird die <em>sukzessive Approximation (SAR-Wandler)</em> verwendet sodass der Fokus auf diesem Wandler ist.</p>
<p><img alt="Blockschaltbild SAR" src="../ressources/5/SAR01.png" /></p>
<p><strong>Sample &amp; Hold Schaltung</strong></p>
<p>Hält die zu messende Spannung für die Zeit der Wandlung konstant.</p>
<p><strong>Komperator</strong></p>
<p><em>"Am Ausgang des Komparators steht ein Signal zur Verfügung, das anzeigt, welche der beiden Eingangsspannungen höher ist. Wenn die Spannung am positiven, nicht-invertierenden Eingang höher ist als die Spannung am negativen, invertierenden Eingang, so nähert sich die Ausgangsspannung der positiven Versorgungsspannung. Bei umgekehrten Verhältnissen geht die Ausgangsspannung gegen die negative Versorgungsspannung."</em> (Wikipedia)</p>
<p><img alt="Beispiel SAR" src="../ressources/5/SAR02.png" /></p>
<h2 id="53-atmega16-adc">5.3 ATmega16 ADC</h2>
<h3 id="531-kenngroen">5.3.1 Kenngrößen</h3>
<p>Ein paar Kenngrößen des ADC im ATmega16:</p>
<ul>
<li>max. 10-bit Auflösung (d.h. 1024 Schritte)</li>
<li>+/- 2 LSB Absolute Accuracy</li>
<li>13-260us Conversion Time</li>
<li>bis zu 15 kSPS bei maximaler Auflösung</li>
<li>8 multiplexed single ended input channels</li>
<li>7 differential input channels</li>
<li>2 differential input channels mit optionaler Verstärung von 10x oder 200x</li>
<li>0-Vcc ADC Input Voltage Range</li>
<li>Auswählbare 2.56V ADC Referenz Spannung</li>
<li>...</li>
</ul>
<h3 id="532-blockschaltbild">5.3.2 Blockschaltbild</h3>
<p><img alt="Blockschaltbild" src="../ressources/5/blockschaltbild.png" /></p>
<h3 id="533-referenzspannung">5.3.3 Referenzspannung</h3>
<p>Ein ADC vergleicht die Messspannung mit einer Referenzspannung. Deshalb kommt der Stabilität der Referenzspannung eine große Bedeutung zu!</p>
<p>Es kann zwischen unterschiedlichen Referenzspannungen gewählt werden (Register ADMUX Bits REFS1 und REFS0):</p>
<ul>
<li>VAcc </li>
<li>Interne 2.56V Referenz Spannung</li>
<li>Externe Spannung an Pin AREF</li>
</ul>
<p>Der Wert der Wandlung (bzw. durch Umstellung der Wert der zu messenden Spannung) berechnet sich mit den folgenden Formeln:</p>
<p><img alt="Formeln" src="../ressources/5/equation.png" /></p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Bedeutung</th>
</tr>
</thead>
<tbody>
<tr>
<td>n</td>
<td>Bitbreite (für ATmega16 -&gt; 10)</td>
</tr>
<tr>
<td>ADC</td>
<td>Wert der Wandlung</td>
</tr>
<tr>
<td>Vin</td>
<td>Spannung am Eingang des ADC</td>
</tr>
<tr>
<td>Vref</td>
<td>Referenzspannung</td>
</tr>
</tbody>
</table>
<h3 id="534-prescaling">5.3.4 Prescaling</h3>
<p>Ein sukzessiver Appriximation Wandler benötigt eine Taktfrequenz zwischen 50kHz und 200kHz um die maximale Auflösung zu erhalten. Sollten weniger als 10 bit Auflösung ausreichen, kann die Taktfrequenz über 200 kHz liegen um einer höhere Abtastrate zu erhalten.</p>
<p>Eine normale Wandlung benötigt 13 ADC Taktzyklen. Die erste Wandlung benötigt 25 Taktzyklen um auch die analoge Schaltung im Mikrocontorller zu initialisieren.</p>
<h3 id="534-multiplexer">5.3.4 Multiplexer</h3>
<p>Es ist nur ein ADC vorhanden, jedoch 8 ADC-Eingänge. Der Multiplexer ermöglicht die Auswahl des ADC Pins (single ended) bzw. der ADC Pins (differential) sowie GND und einer Bandabstandsreferenz (Bandgap reference, 1.23VDC beim ATmega16).</p>
<h3 id="535-adc-register">5.3.5 ADC Register</h3>
<p><em>ADMUX - ADC Multiplexer Selection Register</em></p>
<p><img alt="ADMUX" src="../ressources/5/ADMUX.png" /></p>
<p><em>ADCSRA - ADC Control and Status Register A</em></p>
<p><img alt="ADCSRA" src="../ressources/5/ADCSRA.png" /></p>
<p><em>SFIOR - Special Function IO Register</em></p>
<p><img alt="SFIOR" src="../ressources/5/SFIOR.png" /></p>
<p><em>ADC Data Register - ADCL und ADCH</em></p>
<p><img alt="ADCData" src="../ressources/5/ADCData.png" /></p>
<p><em>Anmerkung:</em> Grundsätzlich wird erst das Low-Byte ausgelesen, danach das High-Byte. Erst wenn auch das High-Byte ausgelesen ist, kann ein neuer Wert in das Register geschrieben wird. Beim GCC gibt es 16-Bit PseudoRegister (<strong>ADC</strong>), bei diesen wird die Zugriffsreihenfolge durch den Compiler automatisch geregelt.</p>
<p>Reicht z.B. eine 8-bit Auflösung des zu messenden Signals, kann man z.B. nur ADCL auslesen.</p>
<h3 id="536-modi">5.3.6 Modi</h3>
<p>Über ADC Auto Trigger Source im Register SFIOR können verschiedene Modi gewählt werden. Diese werden hier kurz vorgestellt:</p>
<p><em>Single Conversion</em></p>
<p>Hier wird das <em>ADSC (ADC Start Converstion)</em> Bit manuell gesetzt. Das Bit bleibt solange gesetzt bis die Wandlung beendet ist. Ein Wechsel des Eingangkanals über den Multiplexer wird erst durchgeführt, wenn die Wandlung beendet ist.</p>
<p><em>Free Running mode</em></p>
<p>Der ADC führt kontinuierlich Wandlungen durch. Die erste Wandlung muss manuell gestartet werden (setzen des ADSC Bit in ADCSRA).</p>
<p><em>Analog Comparator</em></p>
<p>Der Analog Comparator vergleicht die Eingangswerte am positiven Pin AIN0 and negativen Pin AIN1. Wenn die Spannung am positiven Pin AIN0 größer ist als am negativen Pin AIN1, wird der Analog Comparator Output ACO gesetzt. </p>
<p><em>Verschiedene Interrupt (ohne Analog Comparator)</em></p>
<p>Durch setzen der <em>ADC Trigger Select Bits</em> und einschalten des <em>ADC Auto Trigger Enable</em> wird die Wandlung beim Trigger Signal durchgeführt. So können z.B. Wandlungen im festen Takt durchgeführt werden. Nach der Wandlung muss die Interrupt Flag gelöscht werden bevor eine neue Wandlung gemacht wird.</p>
<h3 id="537-unterschied-single-endeddifferential-input">5.3.7 Unterschied single ended/differential input</h3>
<p><strong>Single ended input</strong></p>
<p>Beim single ended input wird eine Spannung gegen den gemeinsamen GND (des Mikrocontrollers) gemessen. </p>
<p><img alt="Single ended" src="../ressources/5/single-ended.png" /></p>
<p>Typische Anwendungsszenarien sind z.B.:</p>
<ul>
<li>Potentiometer um einen Winkel oder Position zu messen</li>
<li>Messung von Lichtstärke</li>
<li>Messung von Distanzen mittels Infrarot/Ultraschall</li>
<li>Messung von Gas- und Luftqualität</li>
</ul>
<table>
<thead>
<tr>
<th>Vorteile</th>
<th>Nachteile</th>
</tr>
</thead>
<tbody>
<tr>
<td>Kostengünstig</td>
<td>Empfindlich ggbr. Störungen auf dem analogen Signalweg</td>
</tr>
<tr>
<td>Nur ein Input-Pin des uC nötig</td>
<td>Empfindlich ggbr. Gleichtaktstörung</td>
</tr>
<tr>
<td>Einfach</td>
<td>Ggfs. höherer Schaltungsaufwand</td>
</tr>
</tbody>
</table>
<p><strong>Übungsbeispiel ADC01 (single ended input)</strong></p>
<p>Es soll die über ein Potentiometer veränderbare Spannung der MEGACARD eingelesen werden und auf dem Display ausgegeben werden (Achtung: Jumper X14 setzen!). Dabei ist der Spannungsbereich ca. von 0V bis 4.76V (d.h. von 0 bis Vcc, die 4.76V sind ein gemessener Wert).</p>
<p>Ablauf:</p>
<ol>
<li>Initialisieren des ADC für ADC5 </li>
<li>Setzen Spannungs-Referenz von AVcc</li>
<li>Setzen des Prescalers zu 128 </li>
<li>Messung starten und Ergebnis abwarten</li>
<li>Berechnen der Spannung und Ausgeben des Ergebnisses auf dem Display</li>
</ol>
<p><strong>main.c</strong></p>
<pre><code>#include &lt;avr/io.h&gt;
#include &lt;util/delay.h&gt;
#include &quot;display.h&quot;

void init (void)
{
   // Grundinitialisierungen
   ADMUX |= (1&lt;&lt;REFS0) | (1&lt;&lt;MUX2) | (1&lt;&lt;MUX0); // Sets AVcc as reference, and selects ADC5
   ADCSRA |= (1&lt;&lt;ADEN) | (1&lt;&lt;ADPS2) | (1&lt;&lt;ADPS1) | (1&lt;&lt;ADPS0); // Enable ADC and set prescaler to 128
}

int read_ADC5(){

    ADCSRA |= (1 &lt;&lt; ADSC); // Manually start new measurement
    while (ADCSRA &amp; (1&lt;&lt;ADSC)); // Wait until ADSC bit is cleared -&gt; conversion complete
    return (ADC); // Return 16-bit value containing both high and low byte 
}

int main (void)
{
   init ();        // Aufruf der Grundinitialisierungen
   display_init(); // Initialisierung der Anzeige

   int out;
   float result;
   out = 0;

   while (1)
   {

      // Hauptschleife
      out = read_ADC5();
      result = (out / 1024.0) * 4.75;
      display_printf_pos (0, 4, &quot;Output: %.3f&quot;, result);

      _delay_ms(500); // delay 500
   }

   return 0;
}

</code></pre>
<p><strong>Übungsbeispiel ADC02 (Wandlung bei Interrupt)</strong></p>
<p>Ergänzen Sie das obige Beispiel so, dass die Messung jeweils <strong>exakt</strong> alle zwei Sekunden durchgeführt wird. </p>
<p><strong>Differential input</strong></p>
<p>Hat jetzt ein Signal z.B. einen Wertebereich zwischen 2 und 3 V so würde beim single ended input Auflösung verloren gehen (weil die 10bit Auflösung für den kompletten Bereich von 0-3 V angewendet werden).</p>
<table>
<thead>
<tr>
<th>Vorteile</th>
<th>Nachteile</th>
</tr>
</thead>
<tbody>
<tr>
<td>Unterdrückt Rauschen im Signal</td>
<td>Benötigt zwei Pins pro Sensor</td>
</tr>
<tr>
<td>Auch für sehr kleine Signale geeignet</td>
<td>Komplexer</td>
</tr>
</tbody>
</table>
<p><img alt="Differential" src="../ressources/5/single-ended-2.png" /></p>
<p>Verwendet man hier nun einen differential input gemäß unten dargestellter Schaltung, kann für das gemessene Signal (hier +/- 0.5V) die volle Auflösung verwendet werden.</p>
<p><img alt="Differential" src="../ressources/5/differential.png" /></p>
<p>Weiterführende Dokumentation zu den beiden Varianten findet sich z.B. <a href="../ressources/5/Differential-and-Single-Ended-ADC-WhitePaper-DS00003197A.pdf">hier.</a></p>
<h3 id="538-genauigkeit-und-fehler">5.3.8 Genauigkeit und Fehler</h3>
<p>Steht im Datenblatt :)</p>
<h3 id="539-elektrische-eigenschaften-adc">5.3.9 Elektrische Eigenschaften (ADC)</h3>
<p>Zu beachtende elektrische Grenzen finden sich in Tabelle 122 (ADC Characteristics) des ATmega16 Datenblatt.</p>
<p>Eine Auswahl ist hier wiedergegeben:</p>
<table>
<thead>
<tr>
<th>Symbol</th>
<th>Parameter</th>
<th>Min</th>
<th>Typ</th>
<th>Max</th>
<th>Units</th>
</tr>
</thead>
<tbody>
<tr>
<td>AVcc</td>
<td>Analog Supply Voltage</td>
<td>Vcc-0.3 (2.7V)</td>
<td></td>
<td>Vcc+0.3 (5.5)</td>
<td>V</td>
</tr>
<tr>
<td>Vref</td>
<td>Reference Voltage - Single Ended</td>
<td>2.0</td>
<td></td>
<td>AVcc</td>
<td>V</td>
</tr>
<tr>
<td>Vref</td>
<td>Reference Voltage - Differential</td>
<td>2.0</td>
<td></td>
<td>AVcc - 0.2</td>
<td>V</td>
</tr>
<tr>
<td>Vin</td>
<td>Input Voltage - Single Ended</td>
<td>GND</td>
<td></td>
<td>Vref</td>
<td>V</td>
</tr>
<tr>
<td>Vin</td>
<td>Input Voltage - Differential</td>
<td>0</td>
<td></td>
<td>Vref</td>
<td>V</td>
</tr>
<tr>
<td>RAin</td>
<td>Analog Input Voltage</td>
<td></td>
<td>100</td>
<td></td>
<td>MOhm</td>
</tr>
</tbody>
</table>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../4_switches/" class="btn btn-neutral float-left" title="4. Schalter / Pegelwandlung"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../6_dac/" class="btn btn-neutral float-right" title="6. DAC - Digital Analog Converter">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../4_switches/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../6_dac/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
